from dotenv import load_dotenv # ุงุณุชูุฑุงุฏ ุฏุงูุฉ ุชุญููู ุงููุชุบูุฑุงุช
load_dotenv() # ุชุญููู ูุชุบูุฑุงุช ุงูุจูุฆุฉ ูู ููู .env
import datetime
from datetime import datetime # ุชู ุงุณุชูุฑุงุฏูุง ูุฑุฉ ุฃุฎุฑู ููุง ูุชุฌูุจ ุฎุทุฃ ุงูุงุณู
import json
import os
# ุงุณุชูุฑุงุฏ ููุชุจุงุช ููุงุฐุฌ ุงูุฐูุงุก ุงูุงุตุทูุงุนู

# --- ุชูุนูู OpenAI ---
#from openai import OpenAI

 #--- ุชุฌููุฏ Google Gemini ---
 import google.generativeai as genai
 
from flask import Flask, request, jsonify, render_template

app = Flask(__name__)

# --- ุชููุฆุฉ ูููุฐุฌ ุงูุฐูุงุก ุงูุงุตุทูุงุนู ---
# ุงูุฎูุงุฑ 1: ุงุณุชุฎุฏุงู OpenAI (ููุนู ุงูุขู)
# ุชุฃูุฏ ูู ุฃู ูุฏูู OPENAI_API_KEY ูู ููู .env
#client = OpenAI(api_key=os.environ.get('OPENAI_API_KEY'))
# ุงุณู ุงููููุฐุฌ ุงูุฃูุถู: 'gpt-4o-mini'
#AI_MODEL_NAME = 'gpt-4o-mini' # ุชู ุชุนููู ุงููููุฐุฌ ูู gpt-4o-mini

# ุงูุฎูุงุฑ 2: ุงุณุชุฎุฏุงู Google Gemini (ูุฌูุฏ ุญุงูููุง)
 genai.configure(api_key=os.environ.get('GEMINI_API_KEY'))
 AI_MODEL_NAME = 'gemini-1.5-pro-latest'
 model = genai.GenerativeModel(AI_MODEL_NAME)


DESCRIPTIONS_FILE = 'descriptions.json'

def load_descriptions():
    if os.path.exists(DESCRIPTIONS_FILE):
        with open(DESCRIPTIONS_FILE, 'r', encoding='utf-8') as f:
            content = f.read()
            if not content:
                return []
            try:
                return json.loads(content)
            except json.JSONDecodeError:
                print(f"Warning: {DESCRIPTIONS_FILE} is corrupted or empty. Returning empty list.")
                return []
    return []

def save_descriptions_to_file(descriptions):
    with open(DESCRIPTIONS_FILE, 'w', encoding='utf-8') as f:
        json.dump(descriptions, f, indent=4, ensure_ascii=False)

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/generate-description', methods=['POST'])
def generate_description():
    data = request.json
    product_title = data.get('product_title')
    # ุชุฃูุฏ ูู ุฃู ุงูููุฒุงุช ุงูุฑุฆูุณูุฉ ูู ูุงุฆูุฉ ุฃู ูุชู ุชูุณูููุง ุจุดูู ุตุญูุญ
    key_features_str = data.get('key_features', '')
    key_features = [f.strip() for f in key_features_str.split(',') if f.strip()] # ุชุญููู ุงูุณูุณูุฉ ุฅูู ูุงุฆูุฉ

    seo_keywords_str = data.get('seo_keywords', '')
    seo_keywords = [k.strip() for k in seo_keywords_str.split(',') if k.strip()] # ุชุญููู ุงูุณูุณูุฉ ุฅูู ูุงุฆูุฉ

    tone = data.get('tone', 'marketing')
    length = data.get('length', 'medium')
    language = data.get('language', 'arabic')

    if not product_title or not key_features or not seo_keywords:
        return jsonify({"error": "ุงูุฑุฌุงุก ุชูููุฑ ุนููุงู ุงูููุชุฌุ ุงูููุฒุงุช ุงูุฑุฆูุณูุฉุ ูุงููููุงุช ุงูููุชุงุญูุฉ ุงููุณุชูุฏูุฉ."}), 400

    # --- ุจูุงุก ุชุนูููุงุช ุงููุบุฉ ---
    language_instruction = ""
    if language == "arabic":
        language_instruction = "ุจุงููุบุฉ ุงูุนุฑุจูุฉ ุงููุตุญู."
    elif language == "english":
        language_instruction = "in English."
    elif language == "spanish":
        language_instruction = "en Espaรฑol."
    else: # ูู ุญุงู ุงุฎุชูุงุฑ ูุบุฉ ุบูุฑ ูุฏุนููุฉุ ุงูุงูุชุฑุงุถู ูู ุงูุนุฑุจูุฉ
        language_instruction = "ุจุงููุบุฉ ุงูุนุฑุจูุฉ ุงููุตุญู."


    # --- ุจูุงุก ุชุนูููุงุช ุงููุจุฑุฉ ---
    prompt_tone_instruction = ""
    if tone == "marketing":
        prompt_tone_instruction = "ุงููุจุฑุฉ: ุชุณููููุฉ ูููุนุฉ. ุฑูุฒ ุนูู ุงูููุงุฆุฏ ุงูุนุงุทููุฉ ูููุณุชุฎุฏู ูุญูุฒู ุนูู ุงุชุฎุงุฐ ูุฑุงุฑ ุงูุดุฑุงุก. ุงุณุชุฎุฏู ูุบุฉ ุฌุฐุงุจุฉ ููุจุชูุฑุฉ."
    elif tone == "friendly":
        prompt_tone_instruction = "ุงููุจุฑุฉ: ูุฏูุฏุฉ ูุบูุฑ ุฑุณููุฉ. ุงุฌุนู ุงููุตู ุณูู ุงููุฑุงุกุฉ ููุฃู ุตุฏูููุง ูุชุญุฏุซ."
    elif tone == "formal":
        prompt_tone_instruction = "ุงููุจุฑุฉ: ุฑุณููุฉ ูููููุฉ. ุฑูุฒ ุนูู ุงูุญูุงุฆู ูุงูููุงุตูุงุช ุงูุฏูููุฉ ูุงููุตุฏุงููุฉ."
    elif tone == "luxury":
        prompt_tone_instruction = "ุงููุจุฑุฉ: ูุงุฎุฑุฉ ูุญุตุฑูุฉ. ุงุณุชุฎุฏู ูุบุฉ ุฑุงููุฉ ุชุนูุณ ุงูุฌูุฏุฉ ุงูุนุงููุฉ ูุงูุชูุฑุฏ."
    elif tone == "humorous":
        prompt_tone_instruction = "ุงููุจุฑุฉ: ููุงููุฉ ููุฑุญุฉ. ุงุณุชุฎุฏู ุจุนุถ ุงูููุงูุฉ ุงูุฎูููุฉ ูุฌุฐุจ ุงูุงูุชุจุงู ูุฌุนู ุงููุตู ููุชุนูุง."


    # --- ุจูุงุก ุชุนูููุงุช ุงูุทูู (ูุน ุชูุฏูุฑ ุงููููุงุช/ุงูุชูููุฒ) ---
    prompt_length_instruction = ""
    if length == "short":
        # 40 ูููุฉ ุชุนุงุฏู ุชูุฑูุจุงู 60 ุชููู (ููุณูุงูุฉุ ูุฏ ุชุฒูุฏ ููููุงู ูู ุงูุนุฑุจูุฉ)
        prompt_length_instruction = "ุงูุทูู: **ูุตูุฑ ุฌุฏูุง (ุจุญุฏ ุฃูุตู 40 ูููุฉ)**. ูุฌุจ ุฃู ูููู ุงููุตู ููุฌุฒูุง ููุบุงูุฉ ููุฑูุฒ ุนูู ููุทุฉ ุจูุน ุฑุฆูุณูุฉ ูุงุญุฏุฉ. **ูุง ุชุชุฌุงูุฒ 40 ูููุฉ ุจุฃู ุดูู ูู ุงูุฃุดูุงู.**"
    elif length == "medium":
        # 100-200 ูููุฉ ุชุนุงุฏู ุชูุฑูุจุงู 150-300 ุชููู
        prompt_length_instruction = "ุงูุทูู: **ูุชูุณุท (100-200 ูููุฉ)**. ูู ุจุชุบุทูุฉ ุงูููุฒุงุช ูุงูููุงุฆุฏ ุงูุฑุฆูุณูุฉ ุจุงูุชูุตูู ุงููุงููุ ูุน ุงูุญูุงุธ ุนูู ุงูุฅูุฌุงุฒ. ูุฐุง ุงูุทูู ูุณูุญ ุจุชูุตูู ุฌูุฏ ุฏูู ุฅุทุงูุฉ."
    elif length == "long":
        # 250-400 ูููุฉ ุชุนุงุฏู ุชูุฑูุจุงู 375-600 ุชููู
        prompt_length_instruction = "ุงูุทูู: **ุทููู ูููุตู (250-400 ูููุฉ)**. ุงุดุฑุญ ูู ููุฒุฉ ุจุนููุ ููุฏู ุณููุงุฑูููุงุช ุงุณุชุฎุฏุงูุ ููุฏู ูุนูููุงุช ุดุงููุฉ. ูุฐุง ุงูุทูู ููุงุณุจ ูุตูุญุงุช ุงูููุชุฌุงุช ุงูุชู ุชุชุทูุจ ุชูุตููุงู ุดุงููุงู ูุชุญุณูู ูุญุฑูุงุช ุงูุจุญุซ."


    # --- ุจูุงุก ุงูู Prompt ุงููุญุณูู ุจุงููุงูู (ูุชูุงูู ูุน OpenAI Chat Completions API) ---
    prompt_messages = [
        {
            "role": "system",
            "content": """
            ุฃูุช ุฎุจูุฑ ุชุณููู ุฅุจุฏุงุนู ูุชุญุณูู ูุญุฑูุงุช ุงูุจุญุซ (SEO)ุ ููุฏูู ูุนุฑูุฉ ุนูููุฉ ุจูุง ูุฌุนู ูุตู ุงูููุชุฌ ูููุนูุง ููุญูู ุงููุจูุนุงุช ููุญุชู ูุฑุงุชุจ ูุชูุฏูุฉ ูู ูุชุงุฆุฌ ุงูุจุญุซ.
            ูููุชู ูู ูุชุงุจุฉ ูุตู ุชุณูููู ููุตู ูุฌุฐุงุจ ููุญุณู ููุญุฑูุงุช ุงูุจุญุซ (SEO) ูููุชุฌ ูุนูู.
            """
        },
        {
            "role": "user",
            "content": f"""
            **ูุนูููุงุช ุงูููุชุฌ:**
            ุงุณู ุงูููุชุฌ: {product_title}
            ุงูููุฒุงุช ุงูุฑุฆูุณูุฉ (ููุทูุฉ):
            {chr(10).join([f"- {feat}" for feat in key_features])}
            ุงููููุงุช ุงูููุชุงุญูุฉ ุงููุณุชูุฏูุฉ: {', '.join(seo_keywords)}

            **ุงูุณูุงุช ุงููุทููุจุฉ ูููุตู:**
            - **ุงููุบุฉ:** {language_instruction}
            - **ุงููุจุฑุฉ:** {prompt_tone_instruction}
            - **ุงูุทูู:** {prompt_length_instruction}

            **ุชูุฌููุงุช ุฅุถุงููุฉ ูุฌูุฏุฉ ุงููุตู:**
            1.  **ุงุณุชูุฏู ุงูุนููู ุงููุซุงูู:** ุชุญุฏุซ ูุจุงุดุฑุฉ ูุดุฎุตููุง ุฅูู ุงูุฌูููุฑ ุงููุณุชูุฏู. ุงุณุชุฎุฏู ูุบุฉ ูููุฑุฏุงุช ุชุชูุงุณุจ ูุน ุงูุนููู ุงููุซุงูู (ุชููุน ูุง ูุฏ ูุณุฃููู ุนูู). ุงุฌุนู ุงูุนููู ูุดุนุฑ ุจุงูุงูุฏูุงุฌ ุจุงุณุชุฎุฏุงู ูููุฉ "ุฃูุช".
            2.  **ุงุจุฑุฒ ุงูููุงุฆุฏ ูุง ุงูููุฒุงุช:** ุฑูุฒ ุนูู ููู ูุญู ุงูููุชุฌ ูุดุงูู ุงูุนููู ุฃู ูุญุณู ุญูุงุชู. ููู ููุฒุฉุ ุงุดุฑุญ ุจูุถูุญ ูุงุฆุฏุชูุง ุงููุจุงุดุฑุฉ ูููุณุชุฎุฏู. ุงููุฏู ูู ุจูุน "ุงูุชุฌุฑุจุฉ" ุฃู "ุงูุญู" ูููุณ ูุฌุฑุฏ ุงูููุชุฌ.
            3.  **ุชุฌูุจ ุงูุนุจุงุฑุงุช ุงูุนุงูุฉ ูุงููุจุชุฐูุฉ:** ูุง ุชุณุชุฎุฏู ุนุจุงุฑุงุช ูุซู "ุนุงูู ุงูุฌูุฏุฉ" ุฃู "ูุนุงู" ุจุฏูู ุชูุงุตูู. ูู ูุญุฏุฏูุง ูุฏููููุง ูุฏุฑ ุงูุฅููุงู ูู ุงููุตู. ุงููุตู ุงูุชูุตููู ูุจูู ุงููุตุฏุงููุฉ ููุณุงุนุฏ ุงูุนููู ุนูู ุชุตูุฑ ุงุณุชุฎุฏุงู ุงูููุชุฌ ููุนุฒุฒ ุงูุซูุฉ.
            4.  **ุงุฏุนู ุงูุชูุถููุงุช ุงูุนููุง ุจุงูุญูุงุฆู (ุฅู ูุฌุฏุช):** ุฅุฐุง ูุงู ููุงู ุงุฏุนุงุก ุจุฃู ุงูููุชุฌ "ุงูุฃูุถู" ุฃู "ุงูุฃุณูู"ุ ูุฏู ุฃุณุจุงุจูุง ูุญูุงุฆู ูุญุฏุฏุฉ ุชุฏุนู ูุฐุง ุงูุงุฏุนุงุก.
            5.  **ุงููุบุฉ ุงูุญุณูุฉ (ุฅู ุฃููู):** ุงุณุชุฎุฏู ูููุงุช ุชุตู ููู ูุจุฏู ุงูููุชุฌุ ุฑุงุฆุญุชูุ ูููุณูุ ุตูุชูุ ุฃู ุทุนููุ ููุณุงุนุฏุฉ ุงูุนููู ุนูู ุชุฎูู ุงูุชุฌุฑุจุฉ.
            6.  **ูุงุจููุฉ ุงููุณุญ (Scannability):** ุงุณุชุฎุฏู ุงูุนูุงููู ุงูุฌุฐุงุจุฉุ ูุงูููุงุท ุงูููุทูุฉ (bullet points)ุ ูุงููุณุงุญุงุช ุงูุจูุถุงุก ูุชุณููู ุงููุฑุงุกุฉ. ุงุฌุนู ุงููุต ููุธูุงู ููุงุถุญุงู ุจุตุฑูุงู.
            7.  **ุชุญุณูู ูุญุฑูุงุช ุงูุจุญุซ (SEO):**
                * ุงุฏูุฌ ุงููููุงุช ุงูููุชุงุญูุฉ ุงููุณุชูุฏูุฉ ุจุดูู ุทุจูุนู ูุฐูู ูู ุฌููุน ุฃูุญุงุก ุงููุตูุ ุฎุงุตุฉ ูู ุงูุจุฏุงูุฉ ูุงูููุงูุฉ ูุงูุนูุงููู ุงููุฑุนูุฉ.
                * ุชุฃูุฏ ูู ุฃู ุงููุตู ูุจุฏู ุทุจูุนููุง ููููุนูุง ูููุฑุงุก ุงูุจุดุฑุ ูููุณ ูุฌุฑุฏ ุญุดู ูููุงุช ููุชุงุญูุฉ.
                * ุงุฌุนู ุงููููุงุช ุงูููุชุงุญูุฉ ุฐุงุช ุตูุฉ ุณูุงููุฉ.
                * ูุง ุชุณุชุฎุฏู ุนูุงูุงุช ุงูู HTML ูู ุงููุตู ููุณู.
                * ุชุฌูุจ ุชูุฑุงุฑ ุงููููุงุช ุงูููุชุงุญูุฉ ุจุดูู ูุจุงูุบ ููู (keyword stuffing).
                * ุงุฌุนู ุงููุตู ูุฑูุฏูุง ูุฌุฐุงุจูุง.
            8.  **ุชุฌูุจ ุงูุชูุฑุงุฑ ูู ุงูุตูุงุบุฉ:** ูุง ุชูุฑุฑ ููุณ ุงูุฌููุฉ ุงูุงูุชุชุงุญูุฉ ุฃู ุงูุนุจุงุฑุงุช ุงููุณุชุฎุฏูุฉ ุจุดูู ูุจุงูุบ ููู. ุงุณุชุฎุฏู ูุฑุงุฏูุงุช ูุชููุนุฉ ูุตูุงุบุงุช ูุฎุชููุฉ ูุถูุงู ุงูุฃุตุงูุฉ ูุงูุชูุฑุฏ.

            **ุงููููู ุงูููุชุฑุญ ูููุตู:**
            -   ุนููุงู ุฑุฆูุณู ุฌุฐุงุจ (H1).
            -   ููุฏูุฉ ุขุณุฑุฉ ุชุญุฏุฏ ุญุงุฌุฉ ุงูุนููู ูุชูุฏู ุงูููุชุฌ ูุญู.
            -   ุชูุตูู ุงูููุงุฆุฏ ูุงูููุฒุงุช ูู ููุฑุงุช ุฃู ููุงุท ููุทูุฉ (ููู ููุฒุฉุ ุงุดุฑุญ ุงููุงุฆุฏุฉ ุงูุนุงุฆุฏุฉ ุนูู ุงูุนููู).
            -   ููุฑุฉ ุนู ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู ุฃู ููู ูุญู ุงูููุชุฌ ูุดููุฉ.
            -   ุฏุนูุฉ ูููุฉ ููุนูู (Call to Action) ูู ุงูููุงูุฉ.

            ุงุณุชุฎุฏู ุงูุฑููุฒ ุงูุชุนุจูุฑูุฉ ๐ ุฃู โจ ุฃู ุบูุฑูุง ุฅุฐุง ูุงูุช ููุงุณุจุฉ ูููุจุฑุฉ ุงููุฎุชุงุฑุฉ ูุชุฒูุฏ ูู ุฌุงุฐุจูุฉ ุงููุตู.
            ุงุณุชุฎุฏู ุงูุนูุงููู ุงููุฑุนูุฉ ูุชูุธูู ุงููุตู ูุฌุนูู ูุงุจูุงู ูููุณุญ ุจุตุฑูุงู (ูุซู: **ูุฏุงุนุงู ูููุดุงูู!ุ ุชุฌุฑุจุฉ ูุง ุชููุณู:**).

            ุงูุขูุ ูู ุจุชูููุฏ ุงููุตู ููููุชุฌ ุฃุนูุงู ุจูุงุกู ุนูู ูุฐู ุงูุชุนูููุงุช ุงูุดุงููุฉ:
            """
        }
    ]

    try:
        # --- ุงุณุชุฏุนุงุก API ูู OpenAI (ููุนู ุงูุขู) ---
       # response = client.chat.completions.create(
          #  model=AI_MODEL_NAME,
         #   messages=prompt_messages,
           # temperature=0.7, # ูููุฉ ุจูู 0 ู 1 ููุชุญูู ูู ุงูุฅุจุฏุงุน (0 ุฃูู ุฅุจุฏุงุนูุงุ 1 ุฃูุซุฑ ุฅุจุฏุงุนูุง)
           # max_tokens=600 # ุงูุญุฏ ุงูุฃูุตู ููุชูููุฒ ุงููุฎุฑุฌุฉ ูุชุฌูุจ ุงูุชูุงููู ุงูุนุงููุฉ ุฌุฏูุง
        #)
       # description = response.choices[0].message.content

        # --- ุงุณุชุฏุนุงุก API ูู Google Gemini (ูุฌูุฏ ุญุงูููุง) ---
         response = model.generate_content(prompt_messages)
         description = response.text


        return jsonify({"description": description}), 200
    except Exception as e:
        # ุฑุณุงูุฉ ุฎุทุฃ ุนุงูุฉ ูุฃู ูุดููุฉ ูู ุงูู APIุ ูุน ูุญุงููุฉ ุงูุชุญุฏูุฏ ูู Rate Limit
        if "rate limit" in str(e).lower() or "429" in str(e):
            return jsonify({"error": "ุชุฌุงูุฒุช ุญุฏูุฏ ุงูุงุณุชุฎุฏุงู (Rate Limit)! ูุฑุฌู ุงูุงูุชุธุงุฑ ุจุถุน ุฏูุงุฆู ูุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู."}), 429
        return jsonify({"error": f"ุญุฏุซ ุฎุทุฃ ูู ุชูููุฏ ุงููุตู: {str(e)}"}), 500

@app.route('/save-description', methods=['POST'])
def save_description():
    data = request.json
    description_text = data.get('description')
    product_title = data.get('product_title')
    key_features = data.get('key_features')
    seo_keywords = data.get('seo_keywords')
    tone = data.get('tone')
    length = data.get('length')
    language = data.get('language')
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

    descriptions = load_descriptions()
    descriptions.append({
        "product_title": product_title,
        "key_features": key_features,
        "seo_keywords": seo_keywords,
        "tone": tone,
        "length": length,
        "language": language,
        "description": description_text,
        "timestamp": timestamp
    })
    save_descriptions_to_file(descriptions)
    return jsonify({"message": "ุงููุตู ูุญููุธ ุจูุฌุงุญ!"}), 200

@app.route('/get-history', methods=['GET'])
def get_history():
    descriptions = load_descriptions()
    return jsonify({"history": descriptions}), 200

@app.route('/clear-history', methods=['POST'])
def clear_history():
    save_descriptions_to_file([])
    return jsonify({"message": "ุชู ูุณุญ ุณุฌู ุงูุฃูุตุงู ุจูุฌุงุญ!"}), 200

if __name__ == '__main__':
    app.run(debug=True)